# ETH Time-Series Method Standard v1

## 1. 목적
- 이 기준은 `chainlink_eth_usd.csv`(오라클)와 `uniswap_eth_usd.csv`(DEX 스왑) 데이터를 금융/블록체인 분석에 사용하기 위한 공통 규칙이다.
- 목표는 재현 가능성, 신뢰 가능한 정제, 해석 가능한 시계열 결과를 확보하는 것이다.

## 2. 데이터 성격 정의
- Chainlink: 이벤트 기반 오라클 업데이트 시계열, 기준가격(anchor) 성격.
- Uniswap v3: 체결(스왑) 기반 초고빈도 시계열, 실행가격(executable) 성격.
- 두 소스는 관측 메커니즘이 다르므로 원시값 직접 비교 대신 시간 정렬 후 비교한다.

## 3. 표준 스키마 규칙
- 시간 컬럼은 UTC aware datetime으로 강제 변환한다.
- 가격 컬럼은 `float64`, 수량/거래량 컬럼은 `float64`, 블록번호는 `int64`로 통일한다.
- 필수 컬럼 누락 시 배치 실패 처리한다.
- 1행 = 1 이벤트 원칙을 유지하고, 집계 결과는 별도 테이블로 분리한다.

## 4. 정제 기준 (필수)
- `price <= 0`은 무효치로 제거한다.
- 타임스탬프 파싱 실패 행은 제거하고 로그에 누적한다.
- 완전 중복 행(모든 컬럼 동일)은 1건만 유지한다.
- Chainlink 고유키는 `global_round_id`로 본다. 중복키는 최신 수집행 1건만 유지한다.
- Uniswap 고유키는 `transaction_hash + block_number + timestamp + usdc_amount + eth_amount` 조합으로 본다.
- 극단치 제거는 즉시 삭제가 아니라 `outlier_flag`로 마킹 후 분석 단계에서 선택 적용한다.

## 5. 블록체인 도메인 보정 규칙
- 블록 타임은 시계열 순서 기준으로만 사용하고, 벽시계 시간과 미세 오차가 있음을 허용한다.
- 동일 트랜잭션에서 다중 이벤트가 있을 수 있으므로 tx 단위 집계와 이벤트 단위 분석을 분리한다.
- 오라클 공백 구간은 `staleness_minutes`를 계산해 품질지표로 관리한다.
- Stablecoin(USDC) 디페그 위험이 있을 수 있으므로 대형 괴리 구간은 이벤트 주석을 남긴다.

## 6. 시계열 정렬 기준
- 공통 비교 프레임은 `1m`, `5m`, `1h` bar를 기본으로 생성한다.
- Uniswap 바 가격은 기본 `VWAP`를 사용한다.
- Chainlink는 바 시점까지 마지막 값을 `asof` 방식으로 매핑한다.
- Cross-source 비교는 같은 바 종료시점 기준으로만 수행한다.

## 7. 품질 게이트 (QC)
- Gate A: 시간 역행 행 수 = 0.
- Gate B: 필수 컬럼 null 비율 < 0.1%.
- Gate C: Chainlink 연속 업데이트 간격 p99 < 120분.
- Gate D: Uniswap 음수/양수 수량 부호 규칙 위반(둘 다 0 등) 비율 < 0.01%.
- Gate E: 집계 후 결측 바 비율(1h 기준) < 1%.

## 8. 분석 방법론 (권장 순서)
- Step 1: 단일 소스 기술통계(가격 분포, 수익률 분포, 거래량 분포).
- Step 2: 오라클-DEX 스프레드 분석(절대값, bps, 지속시간, 빈도).
- Step 3: 변동성 레짐 분할(rolling volatility 기반 저/중/고 변동 구간).
- Step 4: 유동성 충격 분석(대형 volume 구간 전후 가격반응).
- Step 5: 이벤트 분석(급등락, 대형 괴리, 비정상 스파이크).

## 9. 핵심 지표 정의
- Return: `r_t = ln(P_t / P_{t-1})`.
- Spread USD: `S_t = P_uni_t - P_cl_t`.
- Spread bps: `Sbps_t = 10000 * (P_uni_t - P_cl_t) / P_cl_t`.
- Realized Vol(윈도우 n): `sqrt(sum(r_t^2))`.
- Staleness: 오라클 최신 갱신시각과 비교시각 차이(분).

## 10. 이상치 처리 정책
- 가격 점프가 1분 기준 절대수익률 15% 초과면 `jump_flag=1`.
- 스프레드 절대값이 rolling p99 초과면 `spread_anomaly=1`.
- 삭제보다 플래그 우선, 민감도 분석에서 포함/제외 두 결과를 모두 보관한다.

## 11. 리포팅 최소 산출물
- 데이터 품질표 1장(QC 통과/실패 항목).
- 기간/행수/커버리지 요약 1장.
- 가격 오버레이 차트 1장, 스프레드 차트 1장.
- 이상 이벤트 Top 20 테이블(시각, 블록, tx, 스프레드, 거래량).

## 12. 재현성 규칙
- 원본(raw) 파일은 불변으로 보관한다.
- 정제(silver), 집계(gold) 산출물은 파일명에 생성일시와 규칙 버전을 포함한다.
- 모든 분석 스크립트는 입력 경로, 버전, 파라미터를 로그에 남긴다.
